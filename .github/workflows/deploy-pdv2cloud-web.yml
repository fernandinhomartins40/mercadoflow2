name: Deploy PDV2Cloud Web to VPS

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'docker-compose.vps.yml'
      - 'deploy/**'
      - '.github/workflows/deploy-pdv2cloud-web.yml'
  workflow_dispatch:

concurrency:
  group: deploy-pdv2cloud-web
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_PASSWORD }}" > ~/.ssh/vps_password
          chmod 600 ~/.ssh/vps_password

      - name: Sync code to VPS
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass rsync

          sshpass -f ~/.ssh/vps_password ssh -o StrictHostKeyChecking=no root@72.60.10.112 "mkdir -p /root/mercadoflow-web"

          echo "=== Verificando estrutura localmente antes do rsync ==="
          ls -la
          ls -la backend/ || echo "Backend not found"
          ls -la frontend/ || echo "Frontend not found"

          sshpass -f ~/.ssh/vps_password rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='build' \
            --exclude='.next' \
            --exclude='*.db' \
            --exclude='*.db-*' \
            --exclude='backend/data' \
            --exclude='backend/logs' \
            --exclude='backend/uploads' \
            --exclude='.env' \
            --exclude='.env.local' \
            --exclude='tools' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ root@72.60.10.112:/root/mercadoflow-web/

          echo "=== Verificando estrutura na VPS apos rsync ==="
          sshpass -f ~/.ssh/vps_password ssh -o StrictHostKeyChecking=no root@72.60.10.112 "ls -la /root/mercadoflow-web/"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: 72.60.10.112
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          timeout: 600s
          command_timeout: 600s
          script: |
            set -e

            echo "=== Iniciando Deploy PDV2Cloud Web ==="

            APP_DIR="/root/mercadoflow-web"
            cd $APP_DIR

            echo "=== Verificando volumes Docker antes de qualquer operacao ==="
            POSTGRES_VOLUME=$(docker volume ls -q | grep -E "mercadoflow.*postgres_data" || echo "")
            REDIS_VOLUME=$(docker volume ls -q | grep -E "mercadoflow.*redis_data" || echo "")

            if [ -n "$POSTGRES_VOLUME" ]; then
              echo "OK Volume postgres_data encontrado: $POSTGRES_VOLUME"
            else
              echo "INFO Volume postgres_data nao existe (sera criado no primeiro deploy)"
            fi

            if [ -n "$REDIS_VOLUME" ]; then
              echo "OK Volume redis_data encontrado: $REDIS_VOLUME"
            else
              echo "INFO Volume redis_data nao existe (sera criado no primeiro deploy)"
            fi

            echo ""
            echo "=== Parando containers (preservando volumes) ==="
            docker-compose -f docker-compose.vps.yml down || true

            echo ""
            echo "=== Limpando versao antiga do MercadoFlow (containers e imagens apenas) ==="
            docker ps -a --format '{{.Names}}' | grep '^mercadoflow' | xargs -r docker rm -f
            docker images --format '{{.Repository}}:{{.Tag}} {{.ID}}' | grep '^mercadoflow' | awk '{print $2}' | xargs -r docker rmi -f

            echo ""
            echo "=== Removendo volumes antigos do SQLite (migracao para PostgreSQL) ==="
            SQLITE_VOLUME=$(docker volume ls -q | grep -E "mercadoflow.*backend_data" || echo "")
            if [ -n "$SQLITE_VOLUME" ]; then
              echo "Detectado volume SQLite antigo: $SQLITE_VOLUME"
              echo "Removendo para migrar para PostgreSQL..."
              docker volume rm $SQLITE_VOLUME || true
              echo "Volume SQLite removido com sucesso"
            else
              echo "Nenhum volume SQLite antigo encontrado"
            fi

            echo ""
            echo "=== Verificacao de integridade dos volumes ==="
            POSTGRES_VOLUME_AFTER=$(docker volume ls -q | grep -E "mercadoflow.*postgres_data" || echo "")
            REDIS_VOLUME_AFTER=$(docker volume ls -q | grep -E "mercadoflow.*redis_data" || echo "")

            if [ -n "$POSTGRES_VOLUME" ] && [ -z "$POSTGRES_VOLUME_AFTER" ]; then
              echo "ERRO CRITICO: Volume postgres_data foi removido inadvertidamente!"
              exit 1
            fi

            if [ -n "$REDIS_VOLUME" ] && [ -z "$REDIS_VOLUME_AFTER" ]; then
              echo "ERRO CRITICO: Volume redis_data foi removido inadvertidamente!"
              exit 1
            fi

            echo "OK Volumes de dados preservados com sucesso"

            echo "Verificando codigo sincronizado..."
            ls -la

            if [ ! -f ".jwt_secret" ]; then
              echo "Gerando novo JWT Secret..."
              openssl rand -hex 32 > .jwt_secret
            fi
            JWT_SECRET=$(cat .jwt_secret)

            if [ ! -f ".db_secret" ]; then
              echo "Gerando novo POSTGRES_PASSWORD..."
              openssl rand -hex 16 > .db_secret
            fi
            DB_PASSWORD=$(cat .db_secret)

            POSTGRES_DB=pdv2cloud
            POSTGRES_USER=pdv2cloud

            echo "Criando arquivo .env..."
            cat > .env << EOF
            NODE_ENV=production
            POSTGRES_DB=${POSTGRES_DB}
            POSTGRES_USER=${POSTGRES_USER}
            POSTGRES_PASSWORD=${DB_PASSWORD}
            DATABASE_URL=jdbc:postgresql://mercadoflow-postgres:5432/${POSTGRES_DB}
            DATABASE_USER=${POSTGRES_USER}
            DATABASE_PASSWORD=${DB_PASSWORD}
            REDIS_URL=redis://mercadoflow-redis:6379
            JWT_SECRET=${JWT_SECRET}
            HMAC_SECRET=${JWT_SECRET}
            CORS_ORIGIN=https://mercadoflow.com,https://www.mercadoflow.com
            REACT_APP_API_BASE_URL=https://mercadoflow.com/api
            BUILD_TIMESTAMP=$(date +%s)
            EOF

            export BUILD_TIMESTAMP=$(date +%s)
            echo "BUILD_TIMESTAMP=${BUILD_TIMESTAMP}"

            echo ""
            echo "=== ForÃ§ando recriaÃ§Ã£o do PostgreSQL com credenciais corretas ==="
            POSTGRES_VOLUME_EXISTS=$(docker volume ls -q | grep -E "mercadoflow.*postgres_data" || echo "")
            if [ -n "$POSTGRES_VOLUME_EXISTS" ]; then
              echo "âš ï¸  Volume PostgreSQL encontrado: $POSTGRES_VOLUME_EXISTS"
              echo "ðŸ”„ Removendo para garantir credenciais corretas..."
              docker volume rm $POSTGRES_VOLUME_EXISTS 2>/dev/null || true
              echo "âœ… Volume removido. SerÃ¡ recriado com as credenciais do .env"
            else
              echo "âœ… Nenhum volume PostgreSQL existente. SerÃ¡ criado com as credenciais corretas."
            fi

            echo ""
            echo "ðŸ“‹ Credenciais PostgreSQL configuradas:"
            echo "   Database: ${POSTGRES_DB}"
            echo "   User: ${POSTGRES_USER}"
            echo "   Password: ****${DB_PASSWORD: -4}"

            echo ""
            echo "=== Validando estrutura do projeto antes do build ==="
            if [ ! -f "backend/pom.xml" ]; then
              echo "ERRO: backend/pom.xml nao encontrado!"
              exit 1
            fi
            echo "OK backend/pom.xml encontrado"

            if [ ! -f "frontend/package.json" ]; then
              echo "ERRO: frontend/package.json nao encontrado!"
              exit 1
            fi
            echo "OK frontend/package.json encontrado"

            echo "=== Limpando recursos antigos (containers e imagens apenas) ==="
            VOLUMES_BEFORE=$(docker volume ls -q | grep -E "mercadoflow.*postgres_data|mercadoflow.*redis_data" | wc -l)
            echo "Volumes de dados antes da limpeza: $VOLUMES_BEFORE"

            docker container prune -f || true
            docker image prune -af || true

            VOLUMES_AFTER=$(docker volume ls -q | grep -E "mercadoflow.*postgres_data|mercadoflow.*redis_data" | wc -l)
            echo "Volumes de dados apos limpeza: $VOLUMES_AFTER"

            if [ "$VOLUMES_BEFORE" -ne "$VOLUMES_AFTER" ]; then
              echo "ERRO CRITICO: Volumes foram removidos durante limpeza!"
              exit 1
            else
              echo "OK Limpeza concluida com seguranca, volumes preservados"
            fi

            echo "Construindo imagens Docker..."
            docker-compose -f docker-compose.vps.yml build --no-cache --pull || { echo "ERRO ao construir imagem Docker"; exit 1; }
            echo "OK Imagens Docker construidas com sucesso"

            echo "Iniciando containers..."
            docker-compose -f docker-compose.vps.yml up -d --remove-orphans || { echo "ERRO ao iniciar containers"; exit 1; }
            echo "OK Containers iniciados"

            echo "Aguardando containers iniciarem (30s)..."
            sleep 30

            echo "=== Verificando status dos containers ==="
            docker-compose -f docker-compose.vps.yml ps

            if ! docker ps | grep -q mercadoflow-postgres; then
              echo "ERRO: Container mercadoflow-postgres nao esta rodando!"
              docker logs mercadoflow-postgres --tail=100
              exit 1
            fi
            echo "OK Container mercadoflow-postgres esta rodando"

            if ! docker ps | grep -q mercadoflow-backend; then
              echo "ERRO: Container mercadoflow-backend nao esta rodando!"
              docker logs mercadoflow-backend --tail=100
              exit 1
            fi
            echo "OK Container mercadoflow-backend esta rodando"

            if ! docker ps | grep -q mercadoflow-frontend; then
              echo "ERRO: Container mercadoflow-frontend nao esta rodando!"
              docker logs mercadoflow-frontend --tail=50
              exit 1
            fi
            echo "OK Container mercadoflow-frontend esta rodando"

            if ! docker ps | grep -q mercadoflow-redis; then
              echo "ERRO: Container mercadoflow-redis nao esta rodando!"
              docker logs mercadoflow-redis --tail=50
              exit 1
            fi
            echo "OK Container mercadoflow-redis esta rodando"

            if ! docker ps | grep -q mercadoflow-nginx; then
              echo "ERRO: Container mercadoflow-nginx nao esta rodando!"
              docker logs mercadoflow-nginx --tail=50
              exit 1
            fi
            echo "OK Container mercadoflow-nginx esta rodando"

            echo "Aguardando aplicacao inicializar (20s)..."
            sleep 20

            echo "=== Criando backup de seguranca do banco de dados ==="
            if docker ps --format '{{.Names}}' | grep -q '^mercadoflow-postgres$'; then
              mkdir -p ${APP_DIR}/backups
              BACKUP_FILE="${APP_DIR}/backups/backup_$(date +%Y%m%d_%H%M%S).sql"
              docker exec mercadoflow-postgres sh -c "pg_dump -U ${POSTGRES_USER} ${POSTGRES_DB} > /tmp/backup.sql" || true
              docker cp mercadoflow-postgres:/tmp/backup.sql "$BACKUP_FILE" || true
              if [ -s "$BACKUP_FILE" ]; then
                BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
                echo "OK Backup criado: $BACKUP_FILE ($BACKUP_SIZE)"
                ls -t ${APP_DIR}/backups/backup_*.sql | tail -n +8 | xargs -r rm
              else
                echo "WARN Backup vazio ou falhou"
              fi
            else
              echo "WARN Postgres nao esta rodando no momento do backup, pulando backup"
            fi

            echo "=== Configurando Nginx do sistema para porta 3300 ==="
            NGINX_CONFIG_FILE="/etc/nginx/sites-available/mercadoflow.conf"
            SSL_CONFIGURED=false
            NGINX_RELOAD=false

            if [ -f "$NGINX_CONFIG_FILE" ]; then
              if grep -q "ssl_certificate.*letsencrypt" "$NGINX_CONFIG_FILE"; then
                echo "OK Configuracao Nginx ja existe com certificados SSL validos"
                SSL_CONFIGURED=true
              else
                echo "WARN Configuracao existe mas sem certificados SSL - sera recriada"
              fi
            else
              echo "INFO Configuracao Nginx nao existe - sera criada"
            fi

            if [ "$SSL_CONFIGURED" = false ]; then
              cat > /etc/nginx/sites-available/mercadoflow.conf << 'NGINX_EOF'
            server {
                listen 80;
                listen [::]:80;
                server_name mercadoflow.com www.mercadoflow.com;
                return 301 https://$server_name$request_uri;
            }

            server {
                listen 443 ssl http2;
                listen [::]:443 ssl http2;
                server_name mercadoflow.com www.mercadoflow.com;

                access_log /var/log/nginx/mercadoflow-access.log;
                error_log /var/log/nginx/mercadoflow-error.log;

                client_max_body_size 50M;
                client_body_timeout 600s;

                location / {
                    proxy_pass http://127.0.0.1:3300;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;

                    proxy_connect_timeout 300s;
                    proxy_send_timeout 300s;
                    proxy_read_timeout 300s;
                }

                location /health {
                    proxy_pass http://127.0.0.1:3300/health;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    access_log off;
                }
            }
            NGINX_EOF

              ln -sf /etc/nginx/sites-available/mercadoflow.conf /etc/nginx/sites-enabled/
              rm -f /etc/nginx/sites-enabled/default
              NGINX_RELOAD=true

              echo "Configurando certificados SSL com Certbot..."
              if certbot --nginx -d mercadoflow.com -d www.mercadoflow.com --non-interactive --agree-tos --email admin@mercadoflow.com --redirect 2>&1 | tee /tmp/certbot.log; then
                echo "OK Certificados SSL configurados com sucesso"
              else
                CERTBOT_OUTPUT=$(cat /tmp/certbot.log)
                if echo "$CERTBOT_OUTPUT" | grep -q "Certificate not yet due for renewal"; then
                  certbot install --nginx -d mercadoflow.com -d www.mercadoflow.com --non-interactive 2>&1 || echo "WARN Certbot install falhou, mas certificados podem estar OK"
                else
                  echo "WARN Erro ao configurar SSL - sera necessario configurar manualmente"
                  echo "Execute: sudo certbot --nginx -d mercadoflow.com -d www.mercadoflow.com"
                fi
              fi
            else
              ln -sf /etc/nginx/sites-available/mercadoflow.conf /etc/nginx/sites-enabled/
            fi

            if [ "$NGINX_RELOAD" = true ]; then
              if nginx -t; then
                systemctl reload nginx
                echo "OK Nginx recarregado com sucesso"
              else
                nginx -t
                exit 1
              fi
            else
              echo "INFO Mantendo Nginx do sistema como esta (SSL configurado previamente)"
            fi

            sleep 3

            echo "=== Verificando portas em uso ==="
            netstat -tulpn | grep ":80 " || echo "WARN Nginx nao encontrado na porta 80"
            netstat -tulpn | grep ":443 " || echo "WARN Nginx nao encontrado na porta 443"
            netstat -tulpn | grep ":3300 " || echo "WARN App nao encontrado na porta 3300"

            echo "=== Verificando health check ==="
            for i in {1..20}; do
              if curl -f http://localhost:3300/health 2>/dev/null; then
                echo "OK PDV2Cloud esta rodando na porta 3300!"
                exit 0
              fi
              echo "Tentativa $i/20 falhou, aguardando 10s..."
              if [ $((i % 4)) -eq 0 ]; then
                docker logs mercadoflow-backend --tail=30
              fi
              sleep 10
            done

            echo "WARN Health check falhou apos 20 tentativas"
            docker-compose -f docker-compose.vps.yml logs
            exit 1

      - name: Verify Deployment
        if: success()
        run: |
          echo "OK Deploy concluido com sucesso!"
          echo "PDV2Cloud disponivel em:"
          echo "   - https://mercadoflow.com"
          echo "   - https://www.mercadoflow.com"
          echo "Health check: https://mercadoflow.com/health"
